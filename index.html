<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
		<title>Food Deliver</title>
		<link rel="stylesheet" href="style.css">
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="contractDelivery_abi.js"></script>
  </head>
  <body>
    <div class="main">
			<div class="section">
				<img src="">主角為餐廳</img>
				<div>訂單資訊: 餐廳、食物...</div>
				<div>消費者資訊: name...</div>
				<button onclick="newOrder()">接單</button>
				
				<hr>
				<div>
					餐廳開始製作餐點，計時
					<div id="cookTime"></div>
					<button onclick="callDeliver()">餐點完成</button>
				</div>

				<!-- <div>
					<div>外送員前往取餐...</div>					
					<button onclick="callDeliver()">取餐完成</button>
				</div> -->
				
				<hr>
				<div>
					外送員開始取餐送餐，計時
					<div id="deliverTime"></div>
					<button onclick="callCustomer()">餐點抵達</button>
				</div>
			</div>

			<div class="section">
				<div id="txStatus">外送區塊鏈</div>
				<div id="ordersChain"></div>
			</div>
		</div>

  	<script>
    var contractDelivery;
		var userAccount;
		
		var timer;
		var orderTime, cookTime, deliverTime = "";

		function displayOrders(oId) {
				getOrderDetails(oId)
				.then(function(order) {
					$("#ordersChain").append(`<div class="order">
							<div>訂單成立時間: ${order.orderTime}</div>
							<div>餐點製作時間: ${order.cookTime}</div>
							<div>餐點運送時間: ${order.deliverTime}</div>
					</div>`);
				});
		}
	  
		function startTimer(eid) {
			let sec = 0, min = 0;
			timer = setInterval(() => {
				sec++;
				if(sec >= 60) {
					sec = 0;
					min++;
				}
				document.getElementById(eid).innerHTML = min + "分" + sec + "秒";
			}, 1000);
		}
		
		function newOrder() {
			orderTime = new Date().toString().substring(0,24);
			cookTime = "製作中..."
			startTimer("cookTime"); // 計時製作時間
			$("#txStatus").text("Creating new order on the blockchain. This may take a while...");
			return contractDelivery.methods.createOrder(orderTime, cookTime, deliverTime)
			.send({ from: userAccount })
			.on("receipt", function(receipt) {
				console.log(receipt);
				$("#txStatus").text("成功建立區塊，紀錄新訂單");
				getOrdersByCustomer(userAccount)
				.then(oIds => Math.max(...oIds))
				.then(displayOrders);
			})
			.on("error", function(error) {
			  $("#txStatus").text(error);
			});
		}
		
		function callDeliver() {
			clearInterval(timer);
			cookTime = document.getElementById("cookTime").innerHTML;
			startTimer("deliverTime");
			
			$("#txStatus").text("Creating new order on the blockchain. This may take a while...");
			return contractDelivery.methods.createOrder(orderTime, cookTime, deliverTime)
			.send({ from: userAccount })
			.on("receipt", function(receipt) {
				$("#txStatus").text("成功建立區塊，紀錄餐點製作時間");
				getOrdersByCustomer(userAccount)
				.then(oIds => Math.max(...oIds))
				.then(displayOrders);
			})
			.on("error", function(error) {
			  $("#txStatus").text(error);
			});
		}
		
		function callCustomer() {
			clearInterval(timer);
			deliverTime = document.getElementById("deliverTime").innerHTML;
			
			$("#txStatus").text("Creating new order on the blockchain. This may take a while...");
			return contractDelivery.methods.createOrder(orderTime, cookTime, deliverTime)
			.send({ from: userAccount })
			.on("receipt", function(receipt) {
				$("#txStatus").text("成功建立區塊，紀錄外送時間");
				getOrdersByCustomer(userAccount)
				.then(oIds => Math.max(...oIds))
				.then(displayOrders);
			})
			.on("error", function(error) {
			  $("#txStatus").text(error);
			});
		}
		
		function getOrdersByCustomer(cust) {
			return contractDelivery.methods.getOrdersByCust(cust).call()
		}

		function getOrderDetails(oId) {
			return contractDelivery.methods.orders(oId).call()
		}
		
		function initBlockChain() {
			console.log(userAccount);
			$("#txStatus").text("Init the blockchain. This may take a while...");
			getOrdersByCustomer(userAccount)
			.then(function(oIds) {
				for(oId of oIds)
					displayOrders(oId);
				$("#txStatus").text("成功建立區塊鏈");
			})			
		}
		
		window.addEventListener('load', function() {	
			if (typeof web3 !== 'undefined') {
			  web3js = new Web3(web3.currentProvider);
				var contractDeliveryAddress = "0xFd81Dd1FF121D9582c6850f7B8C92B7E45E09aE8";
				contractDelivery = new web3js.eth.Contract(contractDeliveryABI, contractDeliveryAddress);

				web3js.eth.getAccounts().then(function(accounts){ userAccount = accounts[0] })
				.then(initBlockChain);
			} else {
			  alert("Please install Metamask on your browser first!");
			}
    })
    </script>
  </body>
</html>
